<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ngaru Anglican Church - Member Dashboard</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Keep all your existing CSS styles, just adding new ones at the end */
        
        /* Live Broadcast Styles */
        .broadcast-container {
            background: linear-gradient(135deg, #1a331a, #2c5c2c);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
            color: white;
        }
        
        .broadcast-header {
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .broadcast-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff0000;
            animation: pulse 2s infinite;
        }
        
        .broadcast-body {
            padding: 2rem;
            text-align: center;
        }
        
        .broadcast-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .spinner-large {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Gospel Content Styles */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .media-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .media-thumbnail {
            height: 160px;
            position: relative;
            overflow: hidden;
        }
        
        .media-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        
        .media-card:hover .media-thumbnail img {
            transform: scale(1.05);
        }
        
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(212, 175, 55, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .play-button:hover {
            background: rgba(212, 175, 55, 1);
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .media-info {
            padding: 1.2rem;
        }
        
        .media-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .media-meta {
            display: flex;
            justify-content: space-between;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* Group Chat Styles */
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            height: 600px;
        }
        
        .chat-sidebar {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 1.2rem;
            border-bottom: 1px solid #eee;
            background: var(--primary);
            color: white;
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 0.5rem;
        }
        
        .chat-item:hover, .chat-item.active {
            background: rgba(44, 92, 44, 0.1);
        }
        
        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: var(--dark);
            font-weight: bold;
        }
        
        .chat-main {
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }
        
        .message.sent {
            align-self: flex-end;
        }
        
        .message.received {
            align-self: flex-start;
        }
        
        .message-bubble {
            padding: 0.8rem 1rem;
            border-radius: 18px;
            position: relative;
        }
        
        .message.sent .message-bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.received .message-bubble {
            background: #e9ecef;
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.3rem;
            text-align: right;
        }
        
        .message.received .message-time {
            text-align: left;
        }
        
        .chat-input-container {
            padding: 1.2rem;
            border-top: 1px solid #eee;
            display: flex;
            gap: 1rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
            font-family: 'Open Sans', sans-serif;
        }
        
        .chat-input:focus {
            border-color: var(--primary);
        }
        
        /* Mobile Responsive Chat */
        @media (max-width: 992px) {
            .chat-container {
                grid-template-columns: 1fr;
                height: 500px;
            }
            
            .chat-sidebar {
                display: none;
            }
            
            .chat-sidebar.active {
                display: flex;
            }
        }
        
        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .notification-panel.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .notification-item.unread {
            background: rgba(44, 92, 44, 0.05);
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(212, 175, 55, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
        }
        
        /* Dark Mode Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }
        
        /* Mobile Menu Improvements */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* Events Calendar */
        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        
        .calendar-day {
            text-align: center;
            padding: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .calendar-date {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .calendar-date:hover {
            background: rgba(44, 92, 44, 0.1);
        }
        
        .calendar-date.active {
            background: var(--primary);
            color: white;
        }
        
        .calendar-date.has-event {
            position: relative;
        }
        
        .calendar-date.has-event::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 5px;
            height: 5px;
            background: var(--secondary);
            border-radius: 50%;
        }
        
        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(44, 92, 44, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }
        
        /* Dark Mode */
        body.dark-mode {
            --primary: #1a331a;
            --secondary: #f0c040;
            --accent: #a0522d;
            --light: #1e1e1e;
            --dark: #f8f5f0;
            --text: #e0e0e0;
            --text-light: #b0b0b0;
            background-color: #121212;
        }
        
        body.dark-mode .dashboard-card,
        body.dark-mode .stat-card,
        body.dark-mode .payment-option,
        body.dark-mode .group-card,
        body.dark-mode .post-item,
        body.dark-mode .media-card,
        body.dark-mode .chat-sidebar,
        body.dark-mode .chat-main,
        body.dark-mode .notification-panel,
        body.dark-mode .settings-nav,
        body.dark-mode .settings-content,
        body.dark-mode .calendar-container {
            background-color: #2d2d2d;
            color: var(--text);
        }
        
        body.dark-mode .data-table {
            background-color: #2d2d2d;
        }
        
        body.dark-mode .data-table th {
            background-color: var(--primary);
        }
        
        body.dark-mode .data-table tr:hover {
            background-color: #3a3a3a;
        }
        
        body.dark-mode .form-control {
            background-color: #3a3a3a;
            border-color: #555;
            color: var(--text);
        }
        
        body.dark-mode .top-header {
            background-color: #2d2d2d;
        }
        
        /* Print Styles */
        @media print {
            .sidebar, .top-header, .notification-icon, .theme-toggle {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
        }
        
        /* Accessibility Improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .focus-visible {
            outline: 3px solid var(--secondary);
            outline-offset: 2px;
        }
        
        /* Performance Optimizations */
        .will-change-transform {
            will-change: transform;
        }
        
        .will-change-opacity {
            will-change: opacity;
        }
    </style>
</head>

<body>
    <!-- Add overlay for mobile menu -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </div>
    
    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header" style="padding: 1.2rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Notifications</h3>
            <button onclick="markAllAsRead()" style="background: none; border: none; color: var(--primary); cursor: pointer;">Mark all as read</button>
        </div>
        <div id="notificationsList">
            <!-- Notifications will be loaded here -->
        </div>
    </div>
    
    <div class="app-container">
        <!-- Keep existing sidebar and main content structure -->
        <!-- ... existing HTML ... -->

        <!-- Entertainment Tab Content -->
        <div id="entertainment" class="tab-content">
            <h2>Church Entertainment</h2>
            
            <!-- Live Broadcast Section -->
            <div class="broadcast-container">
                <div class="broadcast-header">
                    <div>
                        <h3 style="color: white; margin-bottom: 0.5rem;"><i class="fas fa-satellite-dish"></i> Live Broadcast</h3>
                        <div class="broadcast-status">
                            <div class="status-indicator"></div>
                            <span>Live Now - Sunday Service</span>
                        </div>
                    </div>
                    <div>
                        <span id="viewerCount" style="background: rgba(255,255,255,0.2); padding: 0.3rem 0.8rem; border-radius: 20px;">
                            <i class="fas fa-eye"></i> 245 watching
                        </span>
                    </div>
                </div>
                <div class="broadcast-body">
                    <div class="broadcast-loading">
                        <div class="spinner-large"></div>
                        <h3 style="color: white;">Connecting to Live Stream...</h3>
                        <p style="color: rgba(255,255,255,0.8);">Please wait while we connect to the church broadcast</p>
                        <button class="btn" style="background: var(--secondary); color: var(--dark);" onclick="simulateBroadcast()">
                            <i class="fas fa-play"></i> Start Simulated Broadcast
                        </button>
                    </div>
                    <div id="broadcastPlayer" style="display: none;">
                        <!-- Broadcast player would go here -->
                    </div>
                </div>
            </div>
            
            <!-- Gospel Videos Section -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-film"></i> Gospel Videos</h3>
                    <div class="card-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                </div>
                <div class="media-grid" id="gospelVideos">
                    <!-- Gospel videos will be loaded here -->
                </div>
            </div>
            
            <!-- Gospel Music Section -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-music"></i> Gospel Music</h3>
                    <div class="card-icon">
                        <i class="fas fa-headphones"></i>
                    </div>
                </div>
                <div class="media-grid" id="gospelMusic">
                    <!-- Gospel music will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Admin Panel Tab Content -->
        <div id="admin" class="tab-content">
            <h2>Admin Panel</h2>
            <div class="tabs">
                <button class="tab active" data-admin-tab="users">Manage Users</button>
                <button class="tab" data-admin-tab="content">Manage Content</button>
                <button class="tab" data-admin-tab="analytics">Analytics</button>
                <button class="tab" data-admin-tab="settings">Admin Settings</button>
            </div>
            
            <div id="admin-users" class="tab-content active">
                <!-- User management interface -->
            </div>
            
            <div id="admin-content" class="tab-content">
                <!-- Content management interface -->
            </div>
            
            <div id="admin-analytics" class="tab-content">
                <!-- Analytics dashboard -->
            </div>
            
            <div id="admin-settings" class="tab-content">
                <!-- Admin settings interface -->
            </div>
        </div>
        
        <!-- Settings Tab Content -->
        <div id="settings" class="tab-content">
            <h2>Settings</h2>
            <div class="settings-container">
                <div class="settings-nav">
                    <a href="#account" class="settings-nav-item active">Account Settings</a>
                    <a href="#notifications" class="settings-nav-item">Notifications</a>
                    <a href="#privacy" class="settings-nav-item">Privacy</a>
                    <a href="#appearance" class="settings-nav-item">Appearance</a>
                    <a href="#security" class="settings-nav-item">Security</a>
                </div>
                <div class="settings-content">
                    <!-- Settings content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (same as login/signup)
        const firebaseConfig = {
            apiKey: "AIzaSyA7Fx-54SHm02nIszZFSmkqo_S7VPS7W_Y",
            authDomain: "ngaru-church.firebaseapp.com",
            projectId: "ngaru-church",
            storageBucket: "ngaru-church.firebasestorage.app",
            messagingSenderId: "207707689742",
            appId: "1:207707689742:web:954e317f69acc5959cbd5f",
            measurementId: "G-WFBY03PEJH"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(app);
        const db = firebase.firestore(app);
        const storage = firebase.storage(app);
        
        // Current user data
        let currentUser = null;
        let userData = null;
        
        // Gospel Content Data (working YouTube links)
        const gospelVideos = [
            {
                title: "The Power of Worship - Hillsong",
                thumbnail: "https://img.youtube.com/vi/mUtMp7pARKo/maxresdefault.jpg",
                videoId: "mUtMp7pARKo",
                duration: "45:22",
                views: "2.3M",
                type: "worship"
            },
            {
                title: "Sunday Sermon - God's Grace",
                thumbnail: "https://img.youtube.com/vi/0I5wXIh3CvU/maxresdefault.jpg",
                videoId: "0I5wXIh3CvU",
                duration: "38:15",
                views: "1.5M",
                type: "sermon"
            },
            {
                title: "Testimony of Healing",
                thumbnail: "https://img.youtube.com/vi/RT7lZP9ruwI/maxresdefault.jpg",
                videoId: "RT7lZP9ruwI",
                duration: "22:10",
                views: "890K",
                type: "testimony"
            },
            {
                title: "Children's Bible Story",
                thumbnail: "https://img.youtube.com/vi/WD4pG2pvKk4/maxresdefault.jpg",
                videoId: "WD4pG2pvKk4",
                duration: "15:45",
                views: "456K",
                type: "children"
            },
            {
                title: "Prayer Night Live",
                thumbnail: "https://img.youtube.com/vi/7wFmOmrE6n8/maxresdefault.jpg",
                videoId: "7wFmOmrE6n8",
                duration: "1:32:10",
                views: "1.2M",
                type: "prayer"
            }
        ];
        
        const gospelMusic = [
            {
                title: "What A Beautiful Name - Hillsong",
                thumbnail: "https://img.youtube.com/vi/nQWFzMvCfLE/maxresdefault.jpg",
                videoId: "nQWFzMvCfLE",
                duration: "5:32",
                artist: "Hillsong Worship",
                type: "worship"
            },
            {
                title: "Goodness of God",
                thumbnail: "https://img.youtube.com/vi/KD0zhycE97o/maxresdefault.jpg",
                videoId: "KD0zhycE97o",
                duration: "6:15",
                artist: "CeCe Winans",
                type: "worship"
            },
            {
                title: "Way Maker",
                thumbnail: "https://img.youtube.com/vi/FRKc7HjpX_M/maxresdefault.jpg",
                videoId: "FRKc7HjpX_M",
                duration: "7:45",
                artist: "Sinach",
                type: "worship"
            },
            {
                title: "Great Are You Lord",
                thumbnail: "https://img.youtube.com/vi/u3VF4QzN6qg/maxresdefault.jpg",
                videoId: "u3VF4QzN6qg",
                duration: "6:22",
                artist: "All Sons & Daughters",
                type: "worship"
            },
            {
                title: "Reckless Love",
                thumbnail: "https://img.youtube.com/vi/6xx0d3R2LoU/maxresdefault.jpg",
                videoId: "6xx0d3R2LoU",
                duration: "5:18",
                artist: "Cory Asbury",
                type: "worship"
            }
        ];
        
        // Enhanced Mobile Menu
        function setupMobileMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            function toggleMenu() {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
            }
            
            menuToggle.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);
            
            // Close menu when clicking on nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        toggleMenu();
                    }
                });
            });
        }
        
        // Initialize Firebase User
        async function initializeUser() {
            try {
                // Check authentication state
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        
                        // Get user data from Firestore
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (userDoc.exists) {
                            userData = userDoc.data();
                            
                            // Update UI with user data
                            updateUserProfile();
                            
                            // Load user-specific data
                            loadUserData();
                        } else {
                            // Create user document if it doesn't exist
                            await createUserDocument(user);
                        }
                    } else {
                        // Redirect to login if not authenticated
                        window.location.href = 'login.html';
                    }
                });
            } catch (error) {
                console.error('Error initializing user:', error);
                showMessage('error', 'Error loading user data');
            }
        }
        
        async function createUserDocument(user) {
            const userData = {
                uid: user.uid,
                email: user.email,
                firstName: user.displayName?.split(' ')[0] || 'User',
                lastName: user.displayName?.split(' ').slice(1).join(' ') || '',
                role: 'member',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                profile: {
                    avatar: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=2c5c2c&color=fff`
                }
            };
            
            await db.collection('users').doc(user.uid).set(userData);
            return userData;
        }
        
        function updateUserProfile() {
            if (!userData) return;
            
            const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            const initials = (userData.firstName?.[0] || '') + (userData.lastName?.[0] || '');
            
            // Update sidebar
            document.querySelector('.user-avatar').textContent = initials || 'U';
            document.querySelector('.user-info h4').textContent = fullName || userData.email;
            document.querySelector('.user-info p').textContent = userData.role || 'Member';
            
            // Update profile form
            document.getElementById('fullName').value = fullName;
            document.getElementById('email').value = userData.email || '';
            document.getElementById('phone').value = userData.phone || '';
            document.getElementById('dob').value = userData.dob || '';
            document.getElementById('address').value = userData.address || '';
            document.getElementById('bio').value = userData.bio || '';
        }
        
        // Load Gospel Content
        function loadGospelContent() {
            const videosContainer = document.getElementById('gospelVideos');
            const musicContainer = document.getElementById('gospelMusic');
            
            // Load videos
            gospelVideos.forEach(video => {
                const videoCard = createMediaCard(video, 'video');
                videosContainer.appendChild(videoCard);
            });
            
            // Load music
            gospelMusic.forEach(song => {
                const musicCard = createMediaCard(song, 'music');
                musicContainer.appendChild(musicCard);
            });
        }
        
        function createMediaCard(item, type) {
            const card = document.createElement('div');
            card.className = 'media-card';
            
            card.innerHTML = `
                <div class="media-thumbnail">
                    <img src="${item.thumbnail}" alt="${item.title}" loading="lazy">
                    <div class="play-button" onclick="playMedia('${item.videoId}', '${type}')">
                        <i class="fas fa-${type === 'video' ? 'play' : 'play-circle'}"></i>
                    </div>
                </div>
                <div class="media-info">
                    <h4 class="media-title">${item.title}</h4>
                    <div class="media-meta">
                        <span><i class="far fa-clock"></i> ${item.duration}</span>
                        <span><i class="far fa-eye"></i> ${item.views}</span>
                    </div>
                    ${item.artist ? `<p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);"><i class="fas fa-user"></i> ${item.artist}</p>` : ''}
                </div>
            `;
            
            return card;
        }
        
        function playMedia(videoId, type) {
            // In a real app, this would open a player modal or page
            const modalHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center;">
                    <div style="position: relative; width: 90%; max-width: 800px;">
                        <button onclick="closePlayer()" style="position: absolute; top: -40px; right: 0; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div style="position: relative; padding-bottom: 56.25%; height: 0;">
                            <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                            </iframe>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.innerHTML = modalHtml;
            document.body.appendChild(modal);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        function closePlayer() {
            const modal = document.querySelector('body > div:last-child');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        
        // Enhanced Groups with Firebase Integration
        async function loadGroups() {
            try {
                const groupsSnapshot = await db.collection('groups').get();
                const groupsContainer = document.getElementById('all-groups');
                
                groupsContainer.innerHTML = '';
                
                if (groupsSnapshot.empty) {
                    groupsContainer.innerHTML = '<p>No groups found. Create the first one!</p>';
                    return;
                }
                
                groupsSnapshot.forEach(doc => {
                    const group = doc.data();
                    const groupCard = createGroupCard(group);
                    groupsContainer.appendChild(groupCard);
                });
            } catch (error) {
                console.error('Error loading groups:', error);
                showMessage('error', 'Failed to load groups');
            }
        }
        
        function createGroupCard(group) {
            const card = document.createElement('div');
            card.className = 'group-card';
            
            card.innerHTML = `
                <div class="group-header">
                    <div class="group-icon">
                        <i class="fas fa-${getGroupIcon(group.type)}"></i>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 0.2rem;">${group.name}</h3>
                        <p style="margin-bottom: 0;">${group.memberCount || 0} members</p>
                    </div>
                </div>
                <p>${group.description || 'No description provided.'}</p>
                <div class="group-members">
                    <!-- Member avatars would be loaded here -->
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="joinGroup('${group.id}')">
                        <i class="fas fa-user-plus"></i> Join
                    </button>
                    <button class="btn btn-secondary" onclick="viewGroup('${group.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                </div>
            `;
            
            return card;
        }
        
        function getGroupIcon(type) {
            const icons = {
                'fellowship': 'users',
                'ministry': 'hands-helping',
                'study': 'bible',
                'prayer': 'pray',
                'service': 'hands',
                'social': 'comments'
            };
            return icons[type] || 'users';
        }
        
        async function joinGroup(groupId) {
            try {
                await db.collection('groups').doc(groupId).update({
                    members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                    memberCount: firebase.firestore.FieldValue.increment(1)
                });
                
                await db.collection('users').doc(currentUser.uid).update({
                    groups: firebase.firestore.FieldValue.arrayUnion(groupId)
                });
                
                showMessage('success', 'Successfully joined the group!');
            } catch (error) {
                console.error('Error joining group:', error);
                showMessage('error', 'Failed to join group');
            }
        }
        
        // Enhanced Notifications System
        function setupNotifications() {
            const notificationIcon = document.querySelector('.notification-icon');
            const notificationPanel = document.getElementById('notificationPanel');
            const notificationBadge = document.querySelector('.notification-badge');
            
            notificationIcon.addEventListener('click', toggleNotifications);
            
            // Close notifications when clicking outside
            document.addEventListener('click', (e) => {
                if (!notificationIcon.contains(e.target) && !notificationPanel.contains(e.target)) {
                    notificationPanel.classList.remove('active');
                }
            });
            
            // Load notifications
            loadNotifications();
            
            // Listen for new notifications
            setupNotificationListener();
        }
        
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                markAllAsRead();
            }
        }
        
        async function loadNotifications() {
            try {
                const notificationsSnapshot = await db.collection('notifications')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                const notificationsList = document.getElementById('notificationsList');
                notificationsList.innerHTML = '';
                
                let unreadCount = 0;
                
                if (notificationsSnapshot.empty) {
                    notificationsList.innerHTML = '<div class="notification-item"><p>No notifications</p></div>';
                    return;
                }
                
                notificationsSnapshot.forEach(doc => {
                    const notification = doc.data();
                    const notificationItem = createNotificationItem(notification);
                    notificationsList.appendChild(notificationItem);
                    
                    if (!notification.read) {
                        unreadCount++;
                    }
                });
                
                // Update badge
                const badge = document.querySelector('.notification-badge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        function createNotificationItem(notification) {
            const item = document.createElement('div');
            item.className = `notification-item ${notification.read ? '' : 'unread'}`;
            
            const iconClass = {
                'welcome': 'fas fa-church',
                'giving': 'fas fa-donate',
                'event': 'fas fa-calendar-alt',
                'group': 'fas fa-users',
                'prayer': 'fas fa-pray',
                'message': 'fas fa-envelope'
            }[notification.type] || 'fas fa-bell';
            
            item.innerHTML = `
                <div class="notification-icon">
                    <i class="${iconClass}"></i>
                </div>
                <div style="flex: 1;">
                    <h4 style="margin-bottom: 0.3rem; font-size: 1rem;">${notification.title}</h4>
                    <p style="margin-bottom: 0.3rem; color: var(--text-light); font-size: 0.9rem;">${notification.message}</p>
                    <small style="color: var(--text-light);">${formatTime(notification.createdAt?.toDate())}</small>
                </div>
            `;
            
            item.addEventListener('click', () => {
                markNotificationAsRead(notification.id);
                if (notification.actionUrl) {
                    window.location.href = notification.actionUrl;
                }
            });
            
            return item;
        }
        
        function setupNotificationListener() {
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .where('read', '==', false)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            // Show desktop notification
                            if (Notification.permission === 'granted') {
                                const notification = change.doc.data();
                                new Notification(notification.title, {
                                    body: notification.message,
                                    icon: '/icon.png'
                                });
                            }
                            
                            // Reload notifications
                            loadNotifications();
                        }
                    });
                });
        }
        
        async function markNotificationAsRead(notificationId) {
            try {
                await db.collection('notifications').doc(notificationId).update({
                    read: true
                });
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        async function markAllAsRead() {
            try {
                const snapshot = await db.collection('notifications')
                    .where('userId', '==', currentUser.uid)
                    .where('read', '==', false)
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, { read: true });
                });
                
                await batch.commit();
                loadNotifications();
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }
        
        // Dark Mode Toggle
        function setupDarkMode() {
            const themeToggle = document.getElementById('themeToggle');
            const savedTheme = localStorage.getItem('theme') || 'light';
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                
                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('theme', 'dark');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    localStorage.setItem('theme', 'light');
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                }
            });
        }
        
        // Live Broadcast Simulation
        function simulateBroadcast() {
            const loading = document.querySelector('.broadcast-loading');
            const player = document.getElementById('broadcastPlayer');
            const viewerCount = document.getElementById('viewerCount');
            
            // Simulate loading
            loading.style.display = 'none';
            player.style.display = 'block';
            
            // Create simulated player
            player.innerHTML = `
                <div style="background: #000; aspect-ratio: 16/9; border-radius: 8px; position: relative;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;">
                        <i class="fas fa-satellite-dish" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Live Sunday Service Broadcast</h3>
                        <p>Simulated Broadcast - Would connect to live stream in production</p>
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn" style="background: var(--secondary); color: var(--dark);">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <button class="btn btn-secondary" onclick="stopBroadcast()">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Simulate viewer count increase
            let count = 245;
            setInterval(() => {
                count += Math.floor(Math.random() * 3);
                viewerCount.innerHTML = `<i class="fas fa-eye"></i> ${count} watching`;
            }, 5000);
        }
        
        function stopBroadcast() {
            const player = document.getElementById('broadcastPlayer');
            const loading = document.querySelector('.broadcast-loading');
            
            player.style.display = 'none';
            loading.style.display = 'flex';
        }
        
        // Utility Functions
        function formatTime(date) {
            if (!date) return '';
            
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }
        
        function showMessage(type, text) {
            const messageEl = type === 'success' ? document.getElementById('successMessage') : 
                             type === 'error' ? document.getElementById('errorMessage') : null;
            
            if (messageEl) {
                messageEl.querySelector('p').textContent = text;
                messageEl.classList.add('show');
                
                setTimeout(() => {
                    messageEl.classList.remove('show');
                }, 5000);
            }
        }
        
        // Load user-specific data
        async function loadUserData() {
            try {
                // Load giving history
                const givingSnapshot = await db.collection('giving')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('date', 'desc')
                    .limit(10)
                    .get();
                
                const historyTable = document.getElementById('givingHistory');
                historyTable.innerHTML = '';
                
                if (!givingSnapshot.empty) {
                    givingSnapshot.forEach(doc => {
                        const giving = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${giving.date?.toDate().toLocaleDateString()}</td>
                            <td>${giving.type}</td>
                            <td>Ksh ${giving.amount}</td>
                            <td>${giving.method}</td>
                            <td><span style="color: ${giving.status === 'Completed' ? 'var(--success)' : 'var(--warning)'}">${giving.status}</span></td>
                        `;
                        historyTable.appendChild(row);
                    });
                }
                
                // Load user groups
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userGroups = userDoc.data()?.groups || [];
                
                // Load posts
                const postsSnapshot = await db.collection('posts')
                    .where('audience', 'in', ['public', ...userGroups])
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                
                const communityFeed = document.getElementById('communityFeed');
                communityFeed.innerHTML = '';
                
                if (!postsSnapshot.empty) {
                    postsSnapshot.forEach(async (doc) => {
                        const post = doc.data();
                        const authorDoc = await db.collection('users').doc(post.userId).get();
                        const author = authorDoc.data();
                        
                        const postDiv = createPostElement(post, author);
                        communityFeed.appendChild(postDiv);
                    });
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        function createPostElement(post, author) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post-item';
            
            const initials = (author?.firstName?.[0] || '') + (author?.lastName?.[0] || '');
            const fullName = `${author?.firstName || ''} ${author?.lastName || ''}`.trim();
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">${initials || 'U'}</div>
                    <div class="post-info">
                        <h4>${fullName || 'User'}</h4>
                        <p>${formatTime(post.createdAt?.toDate())}</p>
                    </div>
                </div>
                <div class="post-content">
                    <p>${post.content}</p>
                    ${post.type === 'prayer' ? '<span class="btn btn-small" style="background-color: rgba(142, 68, 173, 0.1); color: #8e44ad; margin-top: 0.5rem;">Prayer Request</span>' : ''}
                    ${post.type === 'announcement' ? '<span class="btn btn-small" style="background-color: rgba(52, 152, 219, 0.1); color: var(--info); margin-top: 0.5rem;">Announcement</span>' : ''}
                </div>
                <div class="post-actions">
                    <button class="post-action" onclick="likePost('${post.id}')"><i class="fas fa-thumbs-up"></i> Like (${post.likes || 0})</button>
                    <button class="post-action" onclick="commentOnPost('${post.id}')"><i class="fas fa-comment"></i> Comment (${post.comments || 0})</button>
                    <button class="post-action" onclick="sharePost('${post.id}')"><i class="fas fa-share"></i> Share</button>
                </div>
            `;
            
            return postDiv;
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            // Setup mobile menu
            setupMobileMenu();
            
            // Initialize Firebase user
            await initializeUser();
            
            // Load gospel content
            loadGospelContent();
            
            // Setup notifications
            setupNotifications();
            
            // Setup dark mode
            setupDarkMode();
            
            // Load groups
            loadGroups();
            
            // Initialize all existing event listeners from original code
            // ... (keep all existing event listeners)
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Update online status
            updateOnlineStatus();
            
            // Set up periodic data refresh
            setInterval(loadUserData, 30000); // Refresh every 30 seconds
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + / to focus search
                if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    e.preventDefault();
                    document.querySelector('.search-input')?.focus();
                }
                
                // Esc to close modals
                if (e.key === 'Escape') {
                    closePlayer();
                    document.getElementById('notificationPanel').classList.remove('active');
                }
            });
        });
        
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            const statusIndicator = document.querySelector('.broadcast-status .status-indicator');
            
            if (statusIndicator) {
                statusIndicator.style.backgroundColor = isOnline ? '#00ff00' : '#ff0000';
            }
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                showMessage('success', 'You are back online');
                statusIndicator.style.backgroundColor = '#00ff00';
            });
            
            window.addEventListener('offline', () => {
                showMessage('warning', 'You are offline. Some features may not work.');
                statusIndicator.style.backgroundColor = '#ff0000';
            });
        }
        
        // Enhanced logout function
        async function logout() {
            try {
                // Update last active time
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Sign out from Firebase
                await auth.signOut();
                
                // Clear local storage
                localStorage.clear();
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error logging out:', error);
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
